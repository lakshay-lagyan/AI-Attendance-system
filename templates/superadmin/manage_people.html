{% extends "base.html" %}

{% block title %}Manage People - Super Admin{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/superadmin_dashboard.css') }}">
<style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    
    .sa-layout { display: flex; min-height: 100vh; background: #f5f7fa; }
    
    /* Sidebar Styles */
    .sa-sidebar {
        width: 280px;
        background: linear-gradient(180deg, #9333ea 0%, #581c87 100%);
        color: white;
        display: flex;
        flex-direction: column;
        position: fixed;
        height: 100vh;
        z-index: 1000;
        transition: transform 0.3s ease;
    }
    
    .sa-sidebar-header {
        padding: 2rem 1.5rem;
        border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    
    .sa-sidebar-header h2 {
        font-size: 1.5rem;
        font-weight: 700;
        margin-bottom: 0.25rem;
    }
    
    .sa-sidebar-header p {
        font-size: 0.875rem;
        opacity: 0.8;
    }
    
    .sa-sidebar-nav {
        flex: 1;
        padding: 1.5rem 1rem;
        overflow-y: auto;
    }
    
    .sa-nav-item {
        display: flex;
        align-items: center;
        padding: 0.875rem 1.25rem;
        color: rgba(255,255,255,0.9);
        text-decoration: none;
        border-radius: 0.5rem;
        margin-bottom: 0.5rem;
        transition: all 0.2s;
    }
    
    .sa-nav-item:hover {
        background: rgba(255,255,255,0.1);
        color: white;
    }
    
    .sa-nav-item.active {
        background: rgba(255,255,255,0.15);
        color: white;
        font-weight: 600;
    }
    
    .sa-nav-item i {
        margin-right: 0.75rem;
        width: 1.25rem;
    }
    
    .sa-logout-btn {
        width: 100%;
        display: flex;
        align-items: center;
        padding: 1rem 1.25rem;
        color: rgba(255,255,255,0.9);
        background: transparent;
        border: none;
        border-top: 1px solid rgba(255,255,255,0.1);
        cursor: pointer;
        transition: all 0.2s;
        font-size: 1rem;
    }
    
    .sa-logout-btn:hover {
        background: #dc2626;
        color: white;
    }
    
    .sa-logout-btn i {
        margin-right: 0.75rem;
    }
    
    /* Main Content */
    .sa-main {
        flex: 1;
        margin-left: 280px;
        display: flex;
        flex-direction: column;
    }
    
    .sa-topbar {
        background: white;
        padding: 1.5rem 2rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        display: flex;
        justify-content: space-between;
        align-items: center;
        position: sticky;
        top: 0;
        z-index: 100;
    }
    
    .sa-menu-toggle {
        display: none;
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        color: #374151;
    }
    
    .sa-topbar h1 {
        font-size: 1.875rem;
        font-weight: 700;
        color: #1f2937;
    }
    
    .sa-topbar p {
        color: #6b7280;
        font-size: 0.875rem;
    }
    
    .sa-content {
        flex: 1;
        padding: 2rem;
    }
    
    /* Filters */
    .filters-card {
        background: white;
        border-radius: 16px;
        padding: 1.5rem;
        margin-bottom: 2rem;
        box-shadow: 0 2px 12px rgba(0,0,0,0.06);
    }
    
    .filters-row {
        display: flex;
        gap: 1rem;
        align-items: center;
        flex-wrap: wrap;
    }
    
    .filter-btn {
        padding: 0.75rem 1.5rem;
        border-radius: 999px;
        border: 2px solid #e5e7eb;
        background: white;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        font-size: 0.875rem;
    }
    
    .filter-btn.active {
        background: linear-gradient(135deg, #9333ea, #7c3aed);
        color: white;
        border-color: #9333ea;
    }
    
    .filter-btn:hover:not(.active) {
        border-color: #9333ea;
        color: #9333ea;
    }
    
    .search-box {
        flex: 1;
        min-width: 300px;
    }
    
    .search-box input {
        width: 100%;
        padding: 0.875rem 1.25rem;
        border: 2px solid #e5e7eb;
        border-radius: 999px;
        font-size: 0.875rem;
        transition: all 0.2s;
    }
    
    .search-box input:focus {
        outline: none;
        border-color: #9333ea;
        box-shadow: 0 0 0 3px rgba(147,51,234,0.1);
    }
    
    /* People Grid */
    .people-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
        gap: 1.5rem;
    }
    
    .person-card {
        background: white;
        border-radius: 16px;
        overflow: hidden;
        box-shadow: 0 2px 12px rgba(0,0,0,0.06);
        transition: all 0.3s;
        cursor: pointer;
    }
    
    .person-card:hover {
        box-shadow: 0 8px 24px rgba(0,0,0,0.12);
        transform: translateY(-4px);
    }
    
    .person-header {
        background: linear-gradient(135deg, #9333ea, #7c3aed);
        padding: 1.5rem;
        text-align: center;
        position: relative;
    }
    
    .person-avatar {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        border: 4px solid white;
        margin: 0 auto 1rem;
        object-fit: cover;
        background: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2.5rem;
        color: #9333ea;
    }
    
    .person-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        border-radius: 50%;
    }
    
    .person-name {
        color: white;
        font-size: 1.25rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
    }
    
    .person-role {
        display: inline-block;
        padding: 0.375rem 1rem;
        border-radius: 999px;
        font-size: 0.75rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .role-admin {
        background: #fbbf24;
        color: #92400e;
    }
    
    .role-user {
        background: rgba(255,255,255,0.2);
        color: white;
    }
    
    .person-body {
        padding: 1.5rem;
    }
    
    .person-info {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
        margin-bottom: 1.5rem;
    }
    
    .info-row {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        font-size: 0.875rem;
    }
    
    .info-row i {
        width: 20px;
        color: #9333ea;
    }
    
    .info-row span {
        color: #6b7280;
    }
    
    .person-status {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 1.5rem;
        flex-wrap: wrap;
    }
    
    .status-badge {
        padding: 0.375rem 0.75rem;
        border-radius: 999px;
        font-size: 0.75rem;
        font-weight: 600;
    }
    
    .status-active {
        background: #d1fae5;
        color: #065f46;
    }
    
    .status-blocked {
        background: #fee2e2;
        color: #991b1b;
    }
    
    .person-actions {
        display: flex;
        gap: 0.5rem;
    }
    
    .btn-action {
        flex: 1;
        padding: 0.75rem;
        border-radius: 8px;
        border: none;
        font-weight: 600;
        font-size: 0.875rem;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
    }
    
    .btn-view {
        background: #ede9fe;
        color: #7c3aed;
    }
    
    .btn-view:hover {
        background: #ddd6fe;
    }
    
    .btn-block {
        background: #fee2e2;
        color: #dc2626;
    }
    
    .btn-block:hover {
        background: #fecaca;
    }
    
    .btn-unblock {
        background: #d1fae5;
        color: #059669;
    }
    
    .btn-unblock:hover {
        background: #a7f3d0;
    }
    
    /* Empty State */
    .empty-state {
        text-align: center;
        padding: 4rem 2rem;
        color: #9ca3af;
    }
    
    .empty-state i {
        font-size: 4rem;
        margin-bottom: 1rem;
        opacity: 0.5;
    }
    
    .empty-state h3 {
        font-size: 1.5rem;
        margin-bottom: 0.5rem;
        color: #6b7280;
    }
    
    /* Loading */
    .loading {
        text-align: center;
        padding: 3rem;
    }
    
    .loading i {
        font-size: 3rem;
        color: #9333ea;
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        100% { transform: rotate(360deg); }
    }
    
    /* Mobile Responsive */
    @media (max-width: 1024px) {
        .sa-sidebar {
            transform: translateX(-100%);
        }
        
        .sa-sidebar.active {
            transform: translateX(0);
        }
        
        .sa-main {
            margin-left: 0;
        }
        
        .sa-menu-toggle {
            display: block;
        }
        
        .people-grid {
            grid-template-columns: 1fr;
        }
    }
    
    @media (max-width: 640px) {
        .sa-content {
            padding: 1rem;
        }
        
        .filters-row {
            flex-direction: column;
            align-items: stretch;
        }
        
        .search-box {
            min-width: unset;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="sa-layout">
    <!-- Sidebar -->
    <div class="sa-sidebar" id="sidebar">
        <div class="sa-sidebar-header">
            <h2>Smart Attendance</h2>
            <p>Super Admin Panel</p>
        </div>
        
        <nav class="sa-sidebar-nav">
            <a href="/superadmin/dashboard" class="sa-nav-item">
                <i class="fas fa-tachometer-alt"></i>
                <span>Dashboard</span>
            </a>
            <a href="/superadmin/manage-people" class="sa-nav-item active">
                <i class="fas fa-users"></i>
                <span>Manage People</span>
            </a>
            <a href="/superadmin/cameras" class="sa-nav-item">
                <i class="fas fa-video"></i>
                <span>Camera Manager</span>
            </a>
            <a href="/superadmin/logs" class="sa-nav-item">
                <i class="fas fa-clipboard-list"></i>
                <span>System Logs</span>
            </a>
        </nav>
        
        <button onclick="logout()" class="sa-logout-btn">
            <i class="fas fa-sign-out-alt"></i>
            <span>Logout</span>
        </button>
    </div>
    
    <!-- Main Content -->
    <div class="sa-main">
        <!-- Top Bar -->
        <div class="sa-topbar">
            <button class="sa-menu-toggle" id="menuToggle">
                <i class="fas fa-bars"></i>
            </button>
            <div>
                <h1>Manage People</h1>
                <p>View and manage all registered users and administrators</p>
            </div>
            <button onclick="loadAllPeople()" style="padding: 0.75rem 1.5rem; background: #9333ea; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                <i class="fas fa-sync-alt"></i> Refresh
            </button>
        </div>
        
        <div class="sa-content">
            <!-- Filters -->
            <div class="filters-card">
                <div class="filters-row">
                    <button class="filter-btn active" id="btn-all" onclick="filterPeople('all')">
                        <i class="fas fa-users mr-2"></i> All Users
                    </button>
                    <button class="filter-btn" id="btn-admin" onclick="filterPeople('admin')">
                        <i class="fas fa-user-shield mr-2"></i> Admins Only
                    </button>
                    <button class="filter-btn" id="btn-user" onclick="filterPeople('user')">
                        <i class="fas fa-user mr-2"></i> Users Only
                    </button>
                    <button class="filter-btn" id="btn-active" onclick="filterPeople('active')">
                        <i class="fas fa-check-circle mr-2"></i> Active
                    </button>
                    <button class="filter-btn" id="btn-blocked" onclick="filterPeople('blocked')">
                        <i class="fas fa-ban mr-2"></i> Blocked
                    </button>
                    <div class="search-box">
                        <input type="text" id="searchInput" placeholder="ðŸ” Search by name, email, or department..." oninput="searchPeople()">
                    </div>
                </div>
            </div>
            
            <!-- People Grid -->
            <div id="peopleContainer">
                <div class="loading">
                    <i class="fas fa-spinner"></i>
                    <p>Loading people...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let allPeople = [];
let currentFilter = 'all';

// Sidebar toggle
document.getElementById('menuToggle').addEventListener('click', () => {
    document.getElementById('sidebar').classList.toggle('active');
});

async function loadAllPeople() {
    try {
        const container = document.getElementById('peopleContainer');
        container.innerHTML = '<div class="loading"><i class="fas fa-spinner"></i><p>Loading...</p></div>';
        
        // Load admins
        const adminsResp = await Promise.all([
            apiRequest('/api/superadmin/admins')
        ]);
        
        // const usersData = await usersResp.json();
        const adminsData = await adminsResp.json();
        
        // const users = usersData.users || [];
        const admins = adminsData.admins || [];
        
        // Merge and mark roles
        allPeople = users.map(user => {
            const isAdmin = admins.find(a => a.email === user.email);
            return {
                ...user,
                role: isAdmin ? 'admin' : 'user',
                profile_image: user.profile_image || isAdmin?.profile_image || ''
            };
        });
        
        renderPeople();
    } catch (error) {
        console.error('Error loading people:', error);
        document.getElementById('peopleContainer').innerHTML = `
            <div class="empty-state">
                <i class="fas fa-exclamation-circle"></i>
                <h3>Failed to load</h3>
                <p>${error.message}</p>
            </div>
        `;
    }
}

function renderPeople() {
    const container = document.getElementById('peopleContainer');
    
    let filtered = allPeople;
    
    // Apply filters
    if (currentFilter === 'admin') {
        filtered = allPeople.filter(p => p.role === 'admin');
    } else if (currentFilter === 'user') {
        filtered = allPeople.filter(p => p.role === 'user');
    } else if (currentFilter === 'active') {
        filtered = allPeople.filter(p => p.status === 'active');
    } else if (currentFilter === 'blocked') {
        filtered = allPeople.filter(p => p.status === 'blocked');
    }
    
    // Apply search
    const search = document.getElementById('searchInput').value.toLowerCase();
    if (search) {
        filtered = filtered.filter(p => 
            (p.name || '').toLowerCase().includes(search) ||
            (p.email || '').toLowerCase().includes(search) ||
            (p.department || '').toLowerCase().includes(search)
        );
    }
    
    if (filtered.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-inbox"></i>
                <h3>No people found</h3>
                <p>Try adjusting your filters or search query</p>
            </div>
        `;
        return;
    }
    
    const html = `
        <div class="people-grid">
            ${filtered.map(person => `
                <div class="person-card" onclick="viewPersonDetail('${person._id}')">
                    <div class="person-header">
                        <div class="person-avatar">
                            ${person.profile_image ? 
                                `<img src="${person.profile_image}" alt="${person.name}">` :
                                `<i class="fas fa-user"></i>`
                            }
                        </div>
                        <div class="person-name">${person.name || 'Unknown'}</div>
                        <span class="person-role role-${person.role}">${person.role}</span>
                    </div>
                    <div class="person-body">
                        <div class="person-info">
                            <div class="info-row">
                                <i class="fas fa-envelope"></i>
                                <span>${person.email || 'N/A'}</span>
                            </div>
                            <div class="info-row">
                                <i class="fas fa-building"></i>
                                <span>${person.department || 'No Department'}</span>
                            </div>
                            <div class="info-row">
                                <i class="fas fa-phone"></i>
                                <span>${person.phone || 'No Phone'}</span>
                            </div>
                        </div>
                        <div class="person-status">
                            <span class="status-badge status-${person.status === 'blocked' ? 'blocked' : 'active'}">
                                <i class="fas fa-${person.status === 'blocked' ? 'ban' : 'check-circle'}"></i>
                                ${person.status === 'blocked' ? 'Blocked' : 'Active'}
                            </span>
                        </div>
                        <div class="person-actions" onclick="event.stopPropagation()">
                            <button class="btn-action btn-view" onclick="viewPersonDetail('${person._id}')">
                                <i class="fas fa-eye"></i> View
                            </button>
                            ${person.status === 'blocked' ?
                                `<button class="btn-action btn-unblock" onclick="unblockPerson('${person._id}', '${person.name}')">
                                    <i class="fas fa-check"></i> Unblock
                                </button>` :
                                `<button class="btn-action btn-block" onclick="blockPerson('${person._id}', '${person.name}')">
                                    <i class="fas fa-ban"></i> Block
                                </button>`
                            }
                        </div>
                    </div>
                </div>
            `).join('')}
        </div>
    `;
    
    container.innerHTML = html;
}

function filterPeople(filter) {
    currentFilter = filter;
    
    // Update button styles
    document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
    document.getElementById(`btn-${filter}`).classList.add('active');
    
    renderPeople();
}

function searchPeople() {
    renderPeople();
}

async function blockPerson(personId, personName) {
    if (!confirm(`Block ${personName}? They will not be able to use the system.`)) return;
    
    try {
        const response = await apiRequest('/api/block_user', {
            method: 'POST',
            body: JSON.stringify({ user_id: personId })
        });
        
        const data = await response.json();
        
        if (response.ok) {
            showToast(`${personName} has been blocked`, 'success');
            loadAllPeople();
        } else {
            showToast(data.msg || 'Failed to block user', 'error');
        }
    } catch (error) {
        console.error('Error:', error);
        showToast('Operation failed', 'error');
    }
}

async function unblockPerson(personId, personName) {
    if (!confirm(`Unblock ${personName}? They will regain access to the system.`)) return;
    
    try {
        const response = await apiRequest('/api/unblock_user', {
            method: 'POST',
            body: JSON.stringify({ user_id: personId })
        });
        
        const data = await response.json();
        
        if (response.ok) {
            showToast(`${personName} has been unblocked`, 'success');
            loadAllPeople();
        } else {
            showToast(data.msg || 'Failed to unblock user', 'error');
        }
    } catch (error) {
        console.error('Error:', error);
        showToast('Operation failed', 'error');
    }
}

function viewPersonDetail(personId) {
    // Redirect to detailed view
    window.location.href = `/superadmin/person/${personId}`;
}

// Initialize
document.addEventListener('DOMContentLoaded', () => {
    loadAllPeople();
});
</script>
{% endblock %}
