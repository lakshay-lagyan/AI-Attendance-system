{% extends "base.html" %}

{% block title %}System Logs - Super Admin{% endblock %}


{% block extra_styles %}
<style>
/* Container perspective to enhance 3D effect */
.dashboard-root {
  perspective: 1400px;
  --sidebar-width: 260px;
  --sidebar-compact: 76px;
  --sidebar-transition: 420ms cubic-bezier(.2,.9,.2,1);
}

/* Base sidebar */
.sidebar {
  width: var(--sidebar-width);
  height: 100vh;
  transform-origin: left center;
  backface-visibility: hidden;
  will-change: transform, box-shadow;
  transition: transform var(--sidebar-transition), box-shadow 260ms ease, width 260ms ease;
  z-index: 50;
  /* keep fixed on small screens so overlay works */
  position: fixed;
  left: 0;
  top: 0;
  overflow: auto;
  -webkit-overflow-scrolling: touch;
}

/* Desktop: static flow (if you prefer static sidebar on wide screens, override with md:static as in your markup) */
/* Keep the 3D transform but align with static layout on medium+ screens */
@media (min-width: 768px) {
  .sidebar {
    position: sticky; /* allows layout flow but still animate visually */
    top: 0;
    height: 100vh;
  }
}

/* Closed state (mobile hidden / desktop partially hidden) */
.sidebar.closed {
  transform: translateX(-100%) rotateY(-12deg) translateZ(-10px) scale(0.98);
  box-shadow: none;
}

/* Open (visible) 3D popped sidebar */
.sidebar.open {
  transform: translateX(0) rotateY(0deg) translateZ(0);
  box-shadow: 0 40px 80px rgba(8, 12, 30, 0.45);
}

/* Compact (desktop collapsed) - icons only */
.sidebar.compact {
  width: var(--sidebar-compact);
  transform: translateX(0) rotateY(-6deg) translateZ(6px) scale(0.99);
}
.sidebar.compact .nav-label { display: none; }
.sidebar.compact .nav-icon { margin-right: 0; text-align: center; width: 100%; }

/* Overlay backdrop for mobile */
.sidebar-backdrop {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.45);
  opacity: 0;
  visibility: hidden;
  transition: opacity 260ms ease, visibility 260ms;
  z-index: 40;
}
.sidebar-backdrop.visible {
  opacity: 1;
  visibility: visible;
}

/* Push content when sidebar open on desktop */
.content-area {
  transition: margin-left var(--sidebar-transition);
}
@media (min-width: 1024px) {
  .content-area.sidebar-open-desktop {
    margin-left: var(--sidebar-width);
  }
  .content-area.sidebar-compact-desktop {
    margin-left: var(--sidebar-compact);
  }
}

/* Menu toggle styling â€” keep it easy to spot */
#menuToggle {
  display: inline-flex;
  align-items: center;
  gap: .5rem;
  padding: .25rem .5rem;
  background: transparent;
  border: none;
  cursor: pointer;
  color: inherit;
}

/* Nice focus ring for keyboard users */
.sidebar :focus,
#menuToggle:focus {
  outline: 3px solid rgba(99,102,241,0.18);
  outline-offset: 2px;
  border-radius: 6px;
}

/* Small visual polish for nav items */
.sidebar .nav-link {
  display: flex;
  gap: 0.75rem;
  align-items: center;
  padding: 0.75rem 1rem;
  border-radius: 8px;
  transition: background 180ms ease, transform 200ms ease;
}
.sidebar .nav-link:hover {
  transform: translateX(4px);
  background: rgba(255,255,255,0.04);
}
.sidebar .nav-icon {
  width: 28px;
  display: inline-flex;
  justify-content: center;
}

/* Responsive adjustments */
@media (max-width: 767px) {
  .sidebar { width: 86%; max-width: 320px; }
  .sidebar.compact { width: 86%; } /* compact mode effectively same as open on mobiles */
  .sidebar.closed { transform: translateX(-110%); }
}

/* Accessibility: reduced-motion */
@media (prefers-reduced-motion: reduce) {
  .sidebar, .content-area, .sidebar-backdrop { transition: none !important; transform: none !important; }
}

/* small helper for page content area to scroll nicely */
.page-inner {
  min-height: 100vh;
  padding: 1rem;
  background: linear-gradient(180deg,#f8fafc 0,#f1f5f9 100%);
}
</style>
{% endblock %}


{% block content %}
<div class="flex h-screen bg-gray-100">
    <div id="sidebar" class="sidebar fixed md:static w-64 bg-gradient-to-b from-purple-600 to-purple-900 text-white h-full z-50">
        <div class="p-6 border-b border-purple-500">
            <h1 class="text-2xl font-bold">Super Admin</h1>
        </div>
        
        <nav class="p-4">
            <a href="/superadmin/dashboard" class="flex items-center p-3 mb-2 hover:bg-purple-700 rounded-lg">
                <i class="fas fa-dashboard mr-3"></i> Dashboard
            </a>
            <a href="/superadmin/admins" class="flex items-center p-3 mb-2 hover:bg-purple-700 rounded-lg">
                <i class="fas fa-user-shield mr-3"></i> Manage People
            </a>
            <a href="/superadmin/users" class="flex items-center p-3 mb-2 hover:bg-purple-700 rounded-lg">
                <i class="fas fa-users mr-3"></i> All Users
            </a>
            <a href="/superadmin/logs" class="flex items-center p-3 mb-2 bg-purple-700 rounded-lg">
                <i class="fas fa-file-alt mr-3"></i> System Logs
            </a>
            <button onclick="logout()" class="w-full flex items-center p-3 mt-4 hover:bg-red-600 rounded-lg">
                <i class="fas fa-sign-out-alt mr-3"></i> Logout
            </button>
        </nav>
    </div>
    
    <div class="flex-1 overflow-auto">
        <div class="bg-white shadow-sm p-4 flex justify-between items-center">
            <button id="menuToggle" class="md:hidden text-gray-600">
                <i class="fas fa-bars text-2xl"></i>
            </button>
            <h2 class="text-2xl font-bold text-gray-800">System Logs</h2>
            <div class="flex gap-2">
                <select id="filterType" class="px-3 py-2 border rounded-lg">
                    <option value="">All Types</option>
                    <option value="login">Login</option>
                    <option value="enrollment">Enrollment</option>
                    <option value="attendance">Attendance</option>
                    <option value="admin">Admin Action</option>
                </select>
                <button onclick="refreshLogs()" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700">
                    <i class="fas fa-sync-alt"></i>
                </button>
            </div>
        </div>
        
        <div class="p-4 md:p-6">
            <div class="bg-white rounded-lg shadow overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="p-4 text-left">Timestamp</th>
                                <th class="p-4 text-left">Type</th>
                                <th class="p-4 text-left">User</th>
                                <th class="p-4 text-left hidden md:table-cell">Action</th>
                                <th class="p-4 text-left hidden lg:table-cell">Details</th>
                            </tr>
                        </thead>
                        <tbody id="logsTable" class="divide-y">
                            <tr><td colspan="5" class="p-4 text-center">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
                <div class="p-4 border-t">
                    <div class="flex justify-between items-center">
                        <button id="prevPage" onclick="changePage(-1)" class="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300 disabled:opacity-50" disabled>
                            <i class="fas fa-chevron-left"></i> Previous
                        </button>
                        <span id="pageInfo" class="text-sm text-gray-600">Page 1</span>
                        <button id="nextPage" onclick="changePage(1)" class="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300 disabled:opacity-50">
                            Next <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
(function(){
  const sidebar = document.getElementById('sidebar');
  const menuToggle = document.getElementById('menuToggle');
  const body = document.body;
  const content = document.querySelector('.flex-1') || document.querySelector('.content-area');
  // create backdrop
  let backdrop = document.querySelector('.sidebar-backdrop');
  if(!backdrop){
    backdrop = document.createElement('div');
    backdrop.className = 'sidebar-backdrop';
    document.body.appendChild(backdrop);
  }

  // Ensure dashboard-root class on top-level container to enable perspective
  const root = document.querySelector('.flex.h-screen') || document.querySelector('body');
  root.classList.add('dashboard-root');

  // Read persisted desktop compact preference
  const DESKTOP_COMPACT_KEY = 'sa_sidebar_compact';
  function isDesktop() { return window.matchMedia('(min-width: 1024px)').matches; }

  // initialize states
  function init() {
    const compact = localStorage.getItem(DESKTOP_COMPACT_KEY) === '1';
    if (isDesktop() && compact) {
      sidebar.classList.add('compact');
      content && content.classList.add('sidebar-compact-desktop');
    } else {
      sidebar.classList.remove('compact');
      content && content.classList.remove('sidebar-compact-desktop');
    }
    // on narrow screens keep sidebar closed by default
    if (!isDesktop()) {
      sidebar.classList.add('closed');
      backdrop.classList.remove('visible');
      content && content.classList.remove('sidebar-open-desktop');
    } else {
      // open on desktop by default
      sidebar.classList.remove('closed');
      sidebar.classList.add('open');
      content && content.classList.add('sidebar-open-desktop');
      backdrop.classList.remove('visible');
    }
  }

  // Toggle open/close (mobile overlay or desktop push)
  function toggleSidebar() {
    if (isDesktop()) {
      // On desktop: toggle compact mode with Shift+Click OR normal toggle
      if (sidebar.classList.contains('compact')) {
        // expand to full
        sidebar.classList.remove('compact');
        sidebar.classList.add('open');
        content && content.classList.remove('sidebar-compact-desktop');
        content && content.classList.add('sidebar-open-desktop');
        localStorage.setItem(DESKTOP_COMPACT_KEY, '0');
      } else if (sidebar.classList.contains('open')) {
        // collapse to compact
        sidebar.classList.remove('open');
        sidebar.classList.add('compact');
        content && content.classList.remove('sidebar-open-desktop');
        content && content.classList.add('sidebar-compact-desktop');
        localStorage.setItem(DESKTOP_COMPACT_KEY, '1');
      } else {
        // if somehow closed, open it
        sidebar.classList.add('open');
        content && content.classList.add('sidebar-open-desktop');
        localStorage.setItem(DESKTOP_COMPACT_KEY, '0');
      }
    } else {
      // Mobile overlay: open/close fully
      if (sidebar.classList.contains('open') && !sidebar.classList.contains('closed')) {
        closeMobile();
      } else {
        openMobile();
      }
    }
    updateAria();
  }

  function openMobile() {
    sidebar.classList.remove('closed');
    sidebar.classList.add('open');
    backdrop.classList.add('visible');
    // lock body scroll
    document.documentElement.style.overflow = 'hidden';
    document.body.style.overflow = 'hidden';
    content && content.classList.remove('sidebar-open-desktop');
    updateAria();
    // focus first focusable element inside sidebar
    setTimeout(()=> {
      const focusable = sidebar.querySelector('button, [href], input, select, textarea');
      if (focusable) focusable.focus();
    }, 120);
  }

  function closeMobile() {
    sidebar.classList.add('closed');
    sidebar.classList.remove('open');
    backdrop.classList.remove('visible');
    document.documentElement.style.overflow = '';
    document.body.style.overflow = '';
    updateAria();
    // return focus to menu toggle
    menuToggle && menuToggle.focus();
  }

  function updateAria() {
    const expanded = sidebar.classList.contains('open') && !sidebar.classList.contains('closed');
    if (menuToggle) menuToggle.setAttribute('aria-expanded', expanded ? 'true' : 'false');
  }

  // Click handlers
  if (menuToggle) {
    menuToggle.addEventListener('click', (e) => {
      // if user holds shift while clicking on desktop, force compact toggle
      if (isDesktop() && e.shiftKey) {
        const isCompact = sidebar.classList.contains('compact');
        if (isCompact) {
          sidebar.classList.remove('compact');
          sidebar.classList.add('open');
          localStorage.setItem(DESKTOP_COMPACT_KEY, '0');
        } else {
          sidebar.classList.remove('open');
          sidebar.classList.add('compact');
          localStorage.setItem(DESKTOP_COMPACT_KEY, '1');
        }
        content && content.classList.toggle('sidebar-compact-desktop');
        return;
      }
      toggleSidebar();
    });
  }

  // Backdrop click closes mobile sidebar
  backdrop.addEventListener('click', () => {
    if (!isDesktop()) closeMobile();
  });

  // Close on Esc
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      if (!isDesktop() && sidebar.classList.contains('open')) {
        closeMobile();
      }
    }
  });

  // Close sidebar on route/navigation (optional hook: look for links inside sidebar)
  sidebar.addEventListener('click', (e) => {
    const link = e.target.closest('a');
    if (link && !isDesktop()) {
      // close overlay when navigating on mobile
      closeMobile();
    }
  });

  // Watch for resize to re-init layout state
  let resizeTimer = null;
  window.addEventListener('resize', () => {
    clearTimeout(resizeTimer);
    resizeTimer = setTimeout(()=> {
      init();
    }, 160);
  });

  // init at load
  document.addEventListener('DOMContentLoaded', init);

  // expose a small API if you want to control from console
  window.SASidebar = {
    openMobile, closeMobile, toggleSidebar,
    setCompact: (v) => {
      if (v) sidebar.classList.add('compact'); else sidebar.classList.remove('compact');
    }
  };
})();
</script>

<script>
let currentPage = 1;
let logs = [];

document.addEventListener('DOMContentLoaded', () => {
    const sidebar = document.getElementById('sidebar');
    const menuToggle = document.getElementById('menuToggle');
    
    menuToggle.addEventListener('click', () => {
        sidebar.classList.toggle('hidden-mobile');
    });
    
    document.getElementById('filterType').addEventListener('change', () => {
        currentPage = 1;
        loadLogs();
    });
    
    loadLogs();
});

async function loadLogs() {
    try {
        const filterType = document.getElementById('filterType').value;
        const url = `/superadmin/logs?page=${currentPage}&per_page=20${filterType ? `&type=${filterType}` : ''}`;
        
        const response = await apiRequest(url);
        const data = await response.json();
        
        if (response.ok) {
            logs = data.logs || [];
            displayLogs(logs);
            updatePagination(data.total || logs.length, data.per_page || 20);
        }
    } catch (error) {
        console.error('Error:', error);
    }
}

function displayLogs(logsList) {
    const tbody = document.getElementById('logsTable');
    
    if (logsList.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="p-4 text-center text-gray-500">No logs found</td></tr>';
        return;
    }
    
    tbody.innerHTML = logsList.map(log => {
        const date = new Date(log.timestamp);
        const typeColors = {
            'login': 'bg-blue-100 text-blue-800',
            'enrollment': 'bg-green-100 text-green-800',
            'attendance': 'bg-purple-100 text-purple-800',
            'admin': 'bg-orange-100 text-orange-800',
            'error': 'bg-red-100 text-red-800'
        };
        
        return `
            <tr class="hover:bg-gray-50">
                <td class="p-4">
                    <div class="text-sm">${date.toLocaleDateString()}</div>
                    <div class="text-xs text-gray-500">${date.toLocaleTimeString()}</div>
                </td>
                <td class="p-4">
                    <span class="px-2 py-1 rounded text-xs font-medium ${typeColors[log.action_type] || 'bg-gray-100 text-gray-800'}">
                        ${log.action_type || 'system'}
                    </span>
                </td>
                <td class="p-4">
                    <div class="text-sm font-medium">${log.user_name || 'System'}</div>
                    <div class="text-xs text-gray-500">${log.user_email || ''}</div>
                </td>
                <td class="p-4 hidden md:table-cell">
                    <div class="text-sm">${log.action || '-'}</div>
                </td>
                <td class="p-4 hidden lg:table-cell">
                    <div class="text-sm text-gray-600">${log.details || '-'}</div>
                </td>
            </tr>
        `;
    }).join('');
}

function updatePagination(total, perPage) {
    const totalPages = Math.ceil(total / perPage);
    document.getElementById('pageInfo').textContent = `Page ${currentPage} of ${totalPages}`;
    document.getElementById('prevPage').disabled = currentPage === 1;
    document.getElementById('nextPage').disabled = currentPage >= totalPages;
}

function changePage(delta) {
    currentPage += delta;
    loadLogs();
}

function refreshLogs() {
    currentPage = 1;
    loadLogs();
    showToast('Logs refreshed', 'success');
}
</script>
{% endblock %}
