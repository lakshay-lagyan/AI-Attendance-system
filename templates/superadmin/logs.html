{% extends "base.html" %}

{% block title %}System Logs - Super Admin{% endblock %}


{% block extra_styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/superadmin_dashboard.css') }}">
<script src="https://cdn.tailwindcss.com"></script>
<style>
@media (max-width: 768px) {
    .sidebar { transform: translateX(-100%); }
    .sidebar.mobile-open { transform: translateX(0) !important; }
    .sa-overlay.active { display: block !important; opacity: 1 !important; }
    .sa-main-content { margin-left: 0 !important; }
}
</style>
{% endblock %}


{% block content %}
<div id="sidebarOverlay" class="sa-overlay"></div>

<div class="dashboard-container">
    <aside id="sidebar" class="sa-sidebar">
        <div class="sa-sidebar-header">
            <h1>Smart Attendance</h1>
            <p class="text-sm opacity-80">Super Admin</p>
        </div>
        
        <nav class="sa-sidebar-nav">
            <a href="/superadmin/dashboard" class="sa-nav-link">
                <i class="fas fa-tachometer-alt"></i> Dashboard
            </a>
            <a href="/superadmin/cameras" class="sa-nav-link">
                <i class="fas fa-video"></i> Camera Manager
            </a>
            <a href="/superadmin/admins" class="sa-nav-link">
                <i class="fas fa-user-shield"></i> Manage Admins
            </a>
            <a href="/superadmin/users" class="sa-nav-link">
                <i class="fas fa-users"></i> All Users
            </a>
            <a href="/superadmin/logs" class="sa-nav-link active">
                <i class="fas fa-clipboard-list"></i> System Logs
            </a>
            <button onclick="logout()" class="sa-logout-btn">
                <i class="fas fa-sign-out-alt"></i> Logout
            </button>
        </nav>
    </aside>
    
    <main class="sa-main-content">
        <div class="sa-topbar">
            <div class="sa-topbar-left">
                <button id="menuToggle" class="sa-menu-toggle">
                    <i class="fas fa-bars"></i>
                </button>
                <h2>System Logs</h2>
            </div>
            <div class="flex gap-2">
                <select id="filterType" class="px-3 py-2 border rounded-lg">
                    <option value="">All Types</option>
                    <option value="login">Login</option>
                    <option value="enrollment">Enrollment</option>
                    <option value="attendance">Attendance</option>
                    <option value="admin">Admin Action</option>
                </select>
                <button onclick="refreshLogs()" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700">
                    <i class="fas fa-sync-alt"></i>
                </button>
            </div>
        </div>
        
        <div class="p-4 md:p-6">
            <div class="bg-white rounded-lg shadow overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="p-4 text-left">Timestamp</th>
                                <th class="p-4 text-left">Type</th>
                                <th class="p-4 text-left">User</th>
                                <th class="p-4 text-left hidden md:table-cell">Action</th>
                                <th class="p-4 text-left hidden lg:table-cell">Details</th>
                            </tr>
                        </thead>
                        <tbody id="logsTable" class="divide-y">
                            <tr><td colspan="5" class="p-4 text-center">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
                <div class="p-4 border-t">
                    <div class="flex justify-between items-center">
                        <button id="prevPage" onclick="changePage(-1)" class="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300 disabled:opacity-50" disabled>
                            <i class="fas fa-chevron-left"></i> Previous
                        </button>
                        <span id="pageInfo" class="text-sm text-gray-600">Page 1</span>
                        <button id="nextPage" onclick="changePage(1)" class="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300 disabled:opacity-50">
                            Next <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let currentPage = 1;
let logs = [];

document.addEventListener('DOMContentLoaded', () => {
    const sidebar = document.getElementById('sidebar');
    const menuToggle = document.getElementById('menuToggle');
    
    menuToggle.addEventListener('click', () => {
        sidebar.classList.toggle('hidden-mobile');
    });
    
    document.getElementById('filterType').addEventListener('change', () => {
        currentPage = 1;
        loadLogs();
    });
    
    loadLogs();
});

async function loadLogs() {
    try {
        const filterType = document.getElementById('filterType').value;
        const url = `/superadmin/logs?page=${currentPage}&per_page=20${filterType ? `&type=${filterType}` : ''}`;
        
        const response = await apiRequest(url);
        const data = await response.json();
        
        if (response.ok) {
            logs = data.logs || [];
            displayLogs(logs);
            updatePagination(data.total || logs.length, data.per_page || 20);
        }
    } catch (error) {
        console.error('Error:', error);
    }
}

function displayLogs(logsList) {
    const tbody = document.getElementById('logsTable');
    
    if (logsList.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="p-4 text-center text-gray-500">No logs found</td></tr>';
        return;
    }
    
    tbody.innerHTML = logsList.map(log => {
        const date = new Date(log.timestamp);
        const typeColors = {
            'login': 'bg-blue-100 text-blue-800',
            'enrollment': 'bg-green-100 text-green-800',
            'attendance': 'bg-purple-100 text-purple-800',
            'admin': 'bg-orange-100 text-orange-800',
            'error': 'bg-red-100 text-red-800'
        };
        
        return `
            <tr class="hover:bg-gray-50">
                <td class="p-4">
                    <div class="text-sm">${date.toLocaleDateString()}</div>
                    <div class="text-xs text-gray-500">${date.toLocaleTimeString()}</div>
                </td>
                <td class="p-4">
                    <span class="px-2 py-1 rounded text-xs font-medium ${typeColors[log.action_type] || 'bg-gray-100 text-gray-800'}">
                        ${log.action_type || 'system'}
                    </span>
                </td>
                <td class="p-4">
                    <div class="text-sm font-medium">${log.user_name || 'System'}</div>
                    <div class="text-xs text-gray-500">${log.user_email || ''}</div>
                </td>
                <td class="p-4 hidden md:table-cell">
                    <div class="text-sm">${log.action || '-'}</div>
                </td>
                <td class="p-4 hidden lg:table-cell">
                    <div class="text-sm text-gray-600">${log.details || '-'}</div>
                </td>
            </tr>
        `;
    }).join('');
}

function updatePagination(total, perPage) {
    const totalPages = Math.ceil(total / perPage);
    document.getElementById('pageInfo').textContent = `Page ${currentPage} of ${totalPages}`;
    document.getElementById('prevPage').disabled = currentPage === 1;
    document.getElementById('nextPage').disabled = currentPage >= totalPages;
}

function changePage(delta) {
    currentPage += delta;
    loadLogs();
}

function refreshLogs() {
    currentPage = 1;
    loadLogs();
    showToast('Logs refreshed', 'success');
}

// Sidebar Toggle
const sidebar = document.getElementById('sidebar');
const menuToggle = document.getElementById('menuToggle');
const overlay = document.getElementById('sidebarOverlay');

menuToggle.addEventListener('click', () => {
    sidebar.classList.toggle('mobile-open');
    overlay.classList.toggle('active');
});

overlay.addEventListener('click', () => {
    sidebar.classList.remove('mobile-open');
    overlay.classList.remove('active');
});

document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
        sidebar.classList.remove('mobile-open');
        overlay.classList.remove('active');
    }
});
</script>
{% endblock %}
