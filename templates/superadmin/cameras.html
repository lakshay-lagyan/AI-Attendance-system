{% extends "base.html" %}

{% block title %}Camera Management - Super Admin{% endblock %}

{% block extra_styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/superadmin_dashboard.css') }}">
<script src="https://cdn.tailwindcss.com"></script>
<style>
@media (max-width: 768px) {
    .sidebar { transform: translateX(-100%); }
    .sidebar.mobile-open { transform: translateX(0) !important; }
    .sa-overlay.active { display: block !important; opacity: 1 !important; }
}
.camera-feed-container {
    position: relative;
    width: 100%;
    padding-top: 56.25%; /* 16:9 aspect ratio */
    background: #000;
    border-radius: 8px;
    overflow: hidden;
}
.camera-feed {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
}
.status-badge {
    position: absolute;
    top: 10px;
    right: 10px;
    padding: 0.5rem 1rem;
    border-radius: 9999px;
    font-size: 0.75rem;
    font-weight: 600;
}
.status-online { background: #10b981; color: white; }
.status-offline { background: #ef4444; color: white; }
.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.7);
}
.modal.active {
    display: flex;
    align-items: center;
    justify-content: center;
}
.modal-content {
    background: white;
    padding: 2rem;
    border-radius: 1rem;
    max-width: 500px;
    width: 90%;
}
</style>
{% endblock %}

{% block content %}
<div id="sidebarOverlay" class="sa-overlay"></div>

<div class="dashboard-container">
    <aside id="sidebar" class="sa-sidebar">
        <div class="sa-sidebar-header">
            <h1>Smart Attendance</h1>
            <p class="text-sm opacity-80">Super Admin</p>
        </div>
        
        <nav class="sa-sidebar-nav">
            <a href="/superadmin/dashboard" class="sa-nav-link">
                <i class="fas fa-tachometer-alt"></i> Dashboard
            </a>
            <a href="/superadmin/cameras" class="sa-nav-link active">
                <i class="fas fa-video"></i> Camera Manager
            </a>
            <a href="/superadmin/admins" class="sa-nav-link">
                <i class="fas fa-user-shield"></i> Manage Admins
            </a>
            <a href="/superadmin/users" class="sa-nav-link">
                <i class="fas fa-users"></i> All Users
            </a>
            <a href="/superadmin/logs" class="sa-nav-link">
                <i class="fas fa-clipboard-list"></i> System Logs
            </a>
            <button onclick="logout()" class="sa-logout-btn">
                <i class="fas fa-sign-out-alt"></i> Logout
            </button>
        </nav>
    </aside>
    
    <main class="sa-main-content">
        <div class="sa-topbar">
            <div class="sa-topbar-left">
                <button id="menuToggle" class="sa-menu-toggle">
                    <i class="fas fa-bars"></i>
                </button>
                <h2>Camera Management</h2>
            </div>
            <button onclick="openAddCameraModal()" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 flex items-center gap-2">
                <i class="fas fa-plus"></i> Add Camera
            </button>
        </div>
        
        <div class="sa-content">
            <!-- Stats -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                <div class="bg-white p-6 rounded-lg shadow">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-500 text-sm">Total Cameras</p>
                            <p id="totalCameras" class="text-3xl font-bold text-blue-600">0</p>
                        </div>
                        <i class="fas fa-video text-4xl text-blue-500"></i>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-lg shadow">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-500 text-sm">Active Cameras</p>
                            <p id="activeCameras" class="text-3xl font-bold text-green-600">0</p>
                        </div>
                        <i class="fas fa-check-circle text-4xl text-green-500"></i>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-lg shadow">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-500 text-sm">Offline Cameras</p>
                            <p id="offlineCameras" class="text-3xl font-bold text-red-600">0</p>
                        </div>
                        <i class="fas fa-times-circle text-4xl text-red-500"></i>
                    </div>
                </div>
            </div>
            
            <!-- Cameras Grid -->
            <div id="camerasGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <div class="col-span-full text-center py-8">
                    <i class="fas fa-video text-6xl text-gray-300 mb-4"></i>
                    <p class="text-gray-500">Loading cameras...</p>
                </div>
            </div>
        </div>
    </main>
</div>

<!-- Add Camera Modal -->
<div id="addCameraModal" class="modal">
    <div class="modal-content">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-2xl font-bold text-gray-900">Add New Camera</h3>
            <button onclick="closeAddCameraModal()" class="text-gray-500 hover:text-gray-700">
                <i class="fas fa-times text-2xl"></i>
            </button>
        </div>
        <form id="addCameraForm" onsubmit="addCamera(event)">
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Camera Name</label>
                    <input type="text" id="cameraName" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500" placeholder="e.g., Main Entrance">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Camera Location</label>
                    <input type="text" id="cameraLocation" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500" placeholder="e.g., Building A, Floor 1">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Camera URL (Optional)</label>
                    <input type="text" id="cameraUrl" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500" placeholder="http://192.168.1.100:8080/video">
                    <p class="text-xs text-gray-500 mt-1">For external IP cameras (RTSP/HTTP stream)</p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Camera Type</label>
                    <select id="cameraType" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500">
                        <option value="0">Webcam (Index 0)</option>
                        <option value="1">Webcam (Index 1)</option>
                        <option value="external">External IP Camera</option>
                    </select>
                </div>
                <div class="flex gap-2 pt-4">
                    <button type="submit" class="flex-1 bg-purple-600 text-white py-2 rounded-lg hover:bg-purple-700">
                        <i class="fas fa-plus mr-2"></i> Add Camera
                    </button>
                    <button type="button" onclick="closeAddCameraModal()" class="px-4 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">
                        Cancel
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<script>
let cameras = [];

document.addEventListener('DOMContentLoaded', () => {
    setupSidebarToggle();
    loadCameras();
    // Auto-refresh every 10 seconds
    setInterval(loadCameras, 10000);
});

function setupSidebarToggle() {
    const sidebar = document.getElementById('sidebar');
    const menuToggle = document.getElementById('menuToggle');
    const overlay = document.getElementById('sidebarOverlay');
    
    menuToggle.addEventListener('click', () => {
        sidebar.classList.toggle('mobile-open');
        overlay.classList.toggle('active');
    });
    
    overlay.addEventListener('click', () => {
        sidebar.classList.remove('mobile-open');
        overlay.classList.remove('active');
    });
    
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            sidebar.classList.remove('mobile-open');
            overlay.classList.remove('active');
            closeAddCameraModal();
        }
    });
}

async function loadCameras() {
    try {
        const response = await fetch('/api/superadmin/cameras');
        if (!response.ok) throw new Error('Failed to load cameras');
        
        const data = await response.json();
        cameras = data.cameras || [];
        
        updateStats();
        displayCameras();
    } catch (error) {
        console.error('Error loading cameras:', error);
        showToast('Failed to load cameras', 'error');
    }
}

function updateStats() {
    const activeCount = cameras.filter(c => c.is_active).length;
    const offlineCount = cameras.filter(c => !c.is_active).length;
    
    document.getElementById('totalCameras').textContent = cameras.length;
    document.getElementById('activeCameras').textContent = activeCount;
    document.getElementById('offlineCameras').textContent = offlineCount;
}

function displayCameras() {
    const grid = document.getElementById('camerasGrid');
    
    if (cameras.length === 0) {
        grid.innerHTML = `
            <div class="col-span-full text-center py-12">
                <i class="fas fa-video-slash text-6xl text-gray-300 mb-4"></i>
                <p class="text-gray-500 text-lg">No cameras added yet</p>
                <button onclick="openAddCameraModal()" class="mt-4 bg-purple-600 text-white px-6 py-2 rounded-lg hover:bg-purple-700">
                    <i class="fas fa-plus mr-2"></i> Add Your First Camera
                </button>
            </div>
        `;
        return;
    }
    
    grid.innerHTML = cameras.map(camera => `
        <div class="bg-white rounded-lg shadow-lg overflow-hidden">
            <div class="camera-feed-container">
                ${camera.is_active ? 
                    `<img src="/camera_feed/${camera.id}" class="camera-feed" alt="${camera.name}">` : 
                    `<div class="camera-feed flex items-center justify-center bg-gray-800">
                        <div class="text-center text-white">
                            <i class="fas fa-video-slash text-5xl mb-3"></i>
                            <p>Camera Offline</p>
                        </div>
                    </div>`
                }
                <span class="status-badge ${camera.is_active ? 'status-online' : 'status-offline'}">
                    <i class="fas fa-circle mr-1"></i> ${camera.is_active ? 'LIVE' : 'OFFLINE'}
                </span>
            </div>
            <div class="p-4">
                <h3 class="text-lg font-bold text-gray-900">${camera.name}</h3>
                <p class="text-sm text-gray-600 mb-3">
                    <i class="fas fa-map-marker-alt mr-1"></i> ${camera.location}
                </p>
                <div class="flex gap-2">
                    ${camera.is_active ? 
                        `<button onclick="stopCamera('${camera.id}')" class="flex-1 bg-red-500 text-white py-2 rounded-lg hover:bg-red-600 text-sm">
                            <i class="fas fa-stop mr-1"></i> Stop
                        </button>` : 
                        `<button onclick="startCamera('${camera.id}')" class="flex-1 bg-green-500 text-white py-2 rounded-lg hover:bg-green-600 text-sm">
                            <i class="fas fa-play mr-1"></i> Start
                        </button>`
                    }
                    <button onclick="deleteCamera('${camera.id}')" class="px-4 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 text-sm">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        </div>
    `).join('');
}

function openAddCameraModal() {
    document.getElementById('addCameraModal').classList.add('active');
    document.getElementById('addCameraForm').reset();
}

function closeAddCameraModal() {
    document.getElementById('addCameraModal').classList.remove('active');
}

async function addCamera(event) {
    event.preventDefault();
    
    const cameraType = document.getElementById('cameraType').value;
    const cameraData = {
        name: document.getElementById('cameraName').value,
        location: document.getElementById('cameraLocation').value,
        camera_index: cameraType === 'external' ? null : parseInt(cameraType),
        stream_url: cameraType === 'external' ? document.getElementById('cameraUrl').value : null
    };
    
    try {
        const response = await fetch('/api/superadmin/cameras', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(cameraData)
        });
        
        const data = await response.json();
        
        if (response.ok) {
            showToast('Camera added successfully!', 'success');
            closeAddCameraModal();
            loadCameras();
        } else {
            showToast(data.error || 'Failed to add camera', 'error');
        }
    } catch (error) {
        console.error('Error adding camera:', error);
        showToast('Failed to add camera', 'error');
    }
}

async function startCamera(cameraId) {
    try {
        const response = await fetch(`/api/superadmin/cameras/${cameraId}/start`, {
            method: 'POST'
        });
        
        if (response.ok) {
            showToast('Camera started successfully', 'success');
            setTimeout(loadCameras, 1000);
        } else {
            const error = await response.json();
            showToast(error.error || 'Failed to start camera', 'error');
        }
    } catch (error) {
        console.error('Error:', error);
        showToast('Failed to start camera', 'error');
    }
}

async function stopCamera(cameraId) {
    try {
        const response = await fetch(`/api/superadmin/cameras/${cameraId}/stop`, {
            method: 'POST'
        });
        
        if (response.ok) {
            showToast('Camera stopped successfully', 'success');
            loadCameras();
        } else {
            const error = await response.json();
            showToast(error.error || 'Failed to stop camera', 'error');
        }
    } catch (error) {
        console.error('Error:', error);
        showToast('Failed to stop camera', 'error');
    }
}

async function deleteCamera(cameraId) {
    if (!confirm('Are you sure you want to delete this camera?')) return;
    
    try {
        const response = await fetch(`/api/superadmin/cameras/${cameraId}`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            showToast('Camera deleted successfully', 'success');
            loadCameras();
        } else {
            const error = await response.json();
            showToast(error.error || 'Failed to delete camera', 'error');
        }
    } catch (error) {
        console.error('Error:', error);
        showToast('Failed to delete camera', 'error');
    }
}
</script>
{% endblock %}
