{% extends "base.html" %}

{% block title %}Super Admin Dashboard{% endblock %}

{% block extra_styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/superadmin_dashboard.css') }}">
{% endblock %}

{% block content %}
<!-- Sidebar Overlay (Mobile) -->
<div class="sa-overlay" id="saOverlay" onclick="toggleSidebar()"></div>

<div class="dashboard-container">
    <!-- Sidebar -->
    <aside class="sa-sidebar" id="saSidebar">
        <div class="sa-sidebar-header">
            <h1>Super Admin</h1>
        </div>
        
        <nav class="sa-sidebar-nav">
            <a href="/superadmin/dashboard" class="sa-nav-link active">
                <i class="fas fa-th-large"></i> Dashboard
            </a>
            <a href="/superadmin/admins" class="sa-nav-link">
                <i class="fas fa-user-shield"></i> Manage Admins
            </a>
            <a href="/superadmin/users" class="sa-nav-link">
                <i class="fas fa-users"></i> All Users
            </a>
            <a href="/superadmin/cameras" class="sa-nav-link">
                <i class="fas fa-video"></i> Cameras
            </a>
            <a href="/superadmin/logs" class="sa-nav-link">
                <i class="fas fa-file-alt"></i> System Logs
            </a>
            <button onclick="logout()" class="sa-logout-btn">
                <i class="fas fa-sign-out-alt"></i> Logout
            </button>
        </nav>
    </aside>
    
    <!-- Main Content -->
    <main class="sa-main-content">
        <!-- Top Bar -->
        <div class="sa-topbar">
            <div class="sa-topbar-left">
                <button class="sa-menu-toggle" id="saMenuToggle" onclick="toggleSidebar()">
                    <i class="fas fa-bars"></i>
                </button>
                <h2>Dashboard</h2>
            </div>
            <div class="sa-user-info" id="userInfo">
                <p class="sa-user-name">Loading...</p>
                <p class="sa-user-email"></p>
            </div>
        </div>
        
        <!-- Content -->
        <div class="sa-content">
            <!-- Stats Grid -->
            <div class="sa-stats-grid">
                <div class="sa-stat-card">
                    <div class="sa-stat-content">
                        <div class="sa-stat-info">
                            <p class="sa-stat-label">Total Admins</p>
                            <p class="sa-stat-value purple" id="totalAdmins">0</p>
                        </div>
                        <i class="fas fa-user-shield sa-stat-icon purple"></i>
                    </div>
                </div>
                
                <div class="sa-stat-card">
                    <div class="sa-stat-content">
                        <div class="sa-stat-info">
                            <p class="sa-stat-label">Total Users</p>
                            <p class="sa-stat-value blue" id="totalUsers">0</p>
                        </div>
                        <i class="fas fa-users sa-stat-icon blue"></i>
                    </div>
                </div>
                
                <div class="sa-stat-card">
                    <div class="sa-stat-content">
                        <div class="sa-stat-info">
                            <p class="sa-stat-label">Pending Enrollments</p>
                            <p class="sa-stat-value green" id="pendingEnrollments">0</p>
                        </div>
                        <i class="fas fa-user-clock sa-stat-icon green"></i>
                    </div>
                </div>
                
                <div class="sa-stat-card">
                    <div class="sa-stat-content">
                        <div class="sa-stat-info">
                            <p class="sa-stat-label">Today's Attendance</p>
                            <p class="sa-stat-value orange" id="todayAttendance">0</p>
                        </div>
                        <i class="fas fa-calendar-check sa-stat-icon orange"></i>
                    </div>
                </div>
            </div>
            
            <!-- Recent Logs -->
            <div class="sa-card">
                <div class="sa-card-header">
                    <h3 class="sa-card-title">Recent System Logs</h3>
                </div>
                <div class="sa-table-container">
                    <table class="sa-table">
                        <thead>
                            <tr>
                                <th>Time</th>
                                <th>User</th>
                                <th>Action</th>
                                <th class="hide-mobile">Details</th>
                            </tr>
                        </thead>
                        <tbody id="logsTable">
                            <tr>
                                <td colspan="4" class="sa-text-center sa-text-muted">Loading...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>
</div>

<script>
function toggleSidebar() {
    const sidebar = document.getElementById('saSidebar');
    const overlay = document.getElementById('saOverlay');
    sidebar.classList.toggle('mobile-open');
    overlay.classList.toggle('active');
}

document.addEventListener('DOMContentLoaded', () => {
    loadUserInfo();
    loadStats();
    loadLogs();
});

async function loadUserInfo() {
    try {
        const response = await apiRequest('/auth/me');
        if (response.user) {
            document.querySelector('.sa-user-name').textContent = response.user.name;
            document.querySelector('.sa-user-email').textContent = response.user.email;
        }
    } catch (error) {
        console.error('Error loading user info:', error);
    }
}

async function loadStats() {
    try {
        const data = await apiRequest('/superadmin/stats');
        document.getElementById('totalAdmins').textContent = data.total_admins || 0;
        document.getElementById('totalUsers').textContent = data.total_users || 0;
        document.getElementById('pendingEnrollments').textContent = data.pending_enrollments || 0;
        document.getElementById('todayAttendance').textContent = data.total_attendance_today || 0;
    } catch (error) {
        console.error('Error loading stats:', error);
    }
}

async function loadLogs() {
    try {
        const response = await fetch('/superadmin/logs?per_page=10');
        const html = await response.text();
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');
        const logsScript = doc.querySelector('script');
        
        // Simple fallback - just show loading message
        document.getElementById('logsTable').innerHTML = 
            '<tr><td colspan="4" class="sa-text-center sa-text-muted">Logs available on dedicated page</td></tr>';
    } catch (error) {
        console.error('Error loading logs:', error);
        document.getElementById('logsTable').innerHTML = 
            '<tr><td colspan="4" class="sa-text-center sa-text-muted">Error loading logs</td></tr>';
    }
}
</script>
{% endblock %}
